name: Import Vlogs to WordPress

on:
  workflow_dispatch:
    inputs:
      jsonl_path:
        description: "Repository path to JSONL import file"
        required: true
        default: "data/vlog-import/vlogs.jsonl"
      post_status:
        description: "Post status (draft/publish/private)"
        required: true
        default: "draft"
  push:
    branches: [ "main" ]
    paths:
      - "data/vlog-import/*.jsonl"
      - "wp-content/themes/flavor-trip/ops/triptalktalk/import-vlogs.wpcli.php"
      - ".github/workflows/import-vlogs.yml"

jobs:
  import:
    runs-on: ubuntu-latest
    env:
      JSONL_PATH: ${{ github.event.inputs.jsonl_path || 'data/vlog-import/vlogs.jsonl' }}
      POST_STATUS: ${{ github.event.inputs.post_status || 'draft' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate import file exists
        run: |
          test -f "$JSONL_PATH" || (echo "Missing $JSONL_PATH" && exit 1)
          echo "Using file: $JSONL_PATH"

      - name: Copy JSONL to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.WP_SSH_HOST }}
          username: ${{ secrets.WP_SSH_USER }}
          key: ${{ secrets.WP_SSH_KEY }}
          source: ${{ env.JSONL_PATH }}
          target: ${{ secrets.WP_IMPORT_DIR }}
          strip_components: 2

      - name: Run WP-CLI import (inside wordpress container)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.WP_SSH_HOST }}
          username: ${{ secrets.WP_SSH_USER }}
          key: ${{ secrets.WP_SSH_KEY }}
          script: |
            set -euxo pipefail
            echo "whoami=$(whoami)"
            echo "pwd=$(pwd)"
            cd "${{ secrets.WP_PATH }}"
            echo "project_dir=$(pwd)"
            sudo git pull origin main
            ls -la
            if [ -f docker-compose.prod.yml ]; then
              COMPOSE_FILE="docker-compose.prod.yml"
            elif [ -f docker-compose.yml ]; then
              COMPOSE_FILE="docker-compose.yml"
            else
              echo "No compose file found (docker-compose.prod.yml or docker-compose.yml)."
              exit 1
            fi
            echo "compose_file=${COMPOSE_FILE}"
            ls -la "${COMPOSE_FILE}"
            echo "host_import_dir=${{ secrets.WP_IMPORT_DIR }}"
            ls -la "${{ secrets.WP_IMPORT_DIR }}" || true

            IMPORT_FILE_IN_CONTAINER="/var/www/html/wp-content/themes/flavor-trip/import/vlogs.jsonl"
            COMPOSE_NEEDS_SUDO=0
            if docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
            elif command -v docker-compose >/dev/null 2>&1; then
              COMPOSE_CMD="docker-compose"
            elif sudo -n docker-compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker-compose"
              COMPOSE_NEEDS_SUDO=1
            else
              echo "Neither 'docker compose' nor 'docker-compose' is available."
              exit 1
            fi

            if [ "$COMPOSE_NEEDS_SUDO" -eq 1 ]; then
              RUN_COMPOSE="sudo -n ${COMPOSE_CMD}"
            else
              RUN_COMPOSE="${COMPOSE_CMD}"
            fi

            echo "compose_cmd=${RUN_COMPOSE}"
            $RUN_COMPOSE -f "${COMPOSE_FILE}" ps

            $RUN_COMPOSE -f "${COMPOSE_FILE}" exec -T wordpress bash -lc \
              "ls -la /var/www/html/wp-content/themes/flavor-trip/import && \
               ls -la /var/www/html/wp-content/themes/flavor-trip/ops/triptalktalk && \
               wp --info --allow-root"

            $RUN_COMPOSE -f "${COMPOSE_FILE}" exec -T wordpress bash -lc \
              "FT_IMPORT_FILE=${IMPORT_FILE_IN_CONTAINER} FT_IMPORT_STATUS=${{ env.POST_STATUS }} FT_IMPORT_AUTHOR=${{ secrets.WP_IMPORT_AUTHOR_ID }} wp eval-file /var/www/html/wp-content/themes/flavor-trip/ops/triptalktalk/import-vlogs.wpcli.php --allow-root"
